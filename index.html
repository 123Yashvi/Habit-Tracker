let goals = [];

function toggleFields() {
  const goalType = document.getElementById('goalType').value;
  const amountSection = document.getElementById('amountSection');
  if (goalType === 'yesno') {
    amountSection.style.display = 'none';
  } else {
    amountSection.style.display = 'block';
    document.getElementById('targetAmount').type = goalType === 'time' ? 'time' : 'number';
  }
}

function toggleProgressFields() {
  const goalType = document.querySelector('#progressGoal option:checked').dataset.type;
  document.getElementById('progressAmountSection').style.display = goalType === 'normal' ? 'block' : 'none';
  document.getElementById('progressTimeSection').style.display = goalType === 'time' ? 'block' : 'none';
  document.getElementById('progressYesNoSection').style.display = goalType === 'yesno' ? 'block' : 'none';
}

function addGoal() {
  const goalName = document.getElementById('goalName').value;
  const goalType = document.getElementById('goalType').value;
  const targetAmount = document.getElementById('targetAmount').value;
  const unit = document.getElementById('unit').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const targetNature = document.getElementById('targetNature').value;

  const goal = {
    name: goalName,
    type: goalType,
    target: targetAmount,
    unit: unit,
    startDate: startDate,
    endDate: endDate,
    targetNature: targetNature,
    achieved: 0,
    daysDone: 0,
    daysLeft: calculateDaysLeft(startDate, endDate),
    speedNow: 0,
    speedRequired: 0,
    status: 'Pending'
  };

  goals.push(goal);
  updateGoalSummary();
  drawChart();
  alert("Goal added successfully!");
}

function addProgress() {
  const progressGoal = document.getElementById('progressGoal').value;
  const progressAmount = document.getElementById('progressAmount').value;
  const progressTime = document.getElementById('progressTime').value;
  const progressYesNo = document.getElementById('progressYesNo').value;
  const progressDate = document.getElementById('progressDate').value;

  const goal = goals.find(g => g.name === progressGoal);
  if (goal) {
    if (goal.type === 'normal') {
      goal.achieved += parseInt(progressAmount);
    } else if (goal.type === 'time') {
      goal.achieved += convertTimeToMinutes(progressTime);
    } else if (goal.type === 'yesno' && progressYesNo === 'yes') {
      goal.achieved += 1; // Increment for yes
    }
    goal.daysDone += 1; // Increment days done
    goal.daysLeft = calculateDaysLeft(goal.startDate, goal.endDate) - goal.daysDone; // Update days left
    updateGoalSummary();
    drawChart();
    alert("Progress added successfully!");
  }
}

function updateGoalSummary() {
  const tbody = document.querySelector('#goalSummary tbody');
  tbody.innerHTML = ''; // Clear existing rows
  goals.forEach(goal => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${goal.name}</td>
      <td>${goal.type}</td>
      <td>${goal.target} ${goal.unit}</td>
      <td>${goal.achieved} ${goal.unit}</td>
      <td>${goal.daysDone}</td>
      <td>${goal.daysLeft}</td>
      <td>${goal.speedNow}</td>
      <td>${goal.speedRequired}</td>
      <td>${goal.status}</td>
      <td><button onclick="removeGoal('${goal.name}')">Remove</button></td>
    `;
    tbody.appendChild(row);
  });
}

function removeGoal(goalName) {
  goals = goals.filter(goal => goal.name !== goalName);
  updateGoalSummary();
  drawChart();
  alert("Goal removed successfully!");
}

function calculateDaysLeft(startDate, endDate) {
  const start = new Date(startDate);
  const end = new Date(endDate);
  const today = new Date();
  return Math.max(0, Math.ceil((end - today) / (1000 * 60 * 60 * 24))); // Days left
}

function convertTimeToMinutes(time) {
  const [hours, minutes] = time.split(':').map(Number);
  return (hours * 60) + minutes; // Convert time to total minutes
}

function drawChart() {
  const ctx = document.getElementById('progressChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: goals.map(g => g.name),
      datasets: [{
        label: 'Target Progress',
        data: goals.map(g => g.achieved),
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
